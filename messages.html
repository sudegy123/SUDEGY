<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>الرسائل - Sudegy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

  <!-- Firebase (compat for simpler integration) -->
<script src="/firebase/firebase-app-compat.js"></script>
<script src="/firebase/firebase-auth-compat.js"></script>
<script src="/firebase/firebase-firestore-compat.js"></script>
<script src="/firebase/firebase-storage-compat.js"></script>

  <style>
    .scrollbar::-webkit-scrollbar { width: 6px; }
    .scrollbar::-webkit-scrollbar-thumb { background: #e2e2e2; border-radius: 20px; }
    body { font-family: 'Tajawal', sans-serif; background: #fff7f0; }
  </style>
</head>

<body class="bg-[#fff7f0]">

  <!-- Header (يمكن استبداله بالهيدر لديك) -->
  <div class="bg-white p-4 shadow-sm flex items-center justify-between">
    <div class="flex items-center gap-3">
      <img src="images/name_user_3716.png" alt="Sudegy" class="h-10">
      <h1 class="font-bold text-lg">الرسائل</h1>
    </div>
    <div>
      <button id="openLoginBtn" class="bg-orange-500 text-white px-4 py-2 rounded-lg text-sm">تسجيل / دخول</button>
      <button id="logoutBtn" class="hidden bg-gray-200 text-gray-800 px-3 py-1 rounded-lg text-sm">تسجيل خروج</button>
    </div>
  </div>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <div class="grid gap-4 md:grid-cols-3">

      <!-- sidebar -->
      <aside id="sidebar" class="bg-white rounded-2xl shadow-sm border border-orange-100 p-4 h-[75vh] flex flex-col">
        <div class="mb-3">
          <input id="searchChats" type="text" placeholder="ابحث في المحادثات..."
            class="w-full text-sm border border-gray-300 rounded-full px-3 py-2 focus:ring-orange-400 focus:border-orange-400">
        </div>

        <div id="chatList" class="flex-1 overflow-y-auto scrollbar divide-y"></div>

        <div class="mt-3 text-center text-xs text-gray-500">
          يمكنك فقط التواصل مع مستخدمين مسجلين فقط.
        </div>
      </aside>

      <!-- chat area -->
      <section class="bg-white rounded-2xl shadow-sm border border-orange-100 p-4 h-[75vh] flex flex-col md:col-span-2">

        <header class="pb-3 mb-3 border-b border-gray-100 flex items-center justify-between">
          <div>
            <h2 id="chatName" class="font-bold text-sm text-gray-900">-- اختر محادثة --</h2>
            <span id="chatStatus" class="text-[11px] text-gray-400">غير متصل</span>
          </div>
          <div class="flex items-center gap-2">
            <span id="statusDot" class="w-2 h-2 rounded-full bg-gray-400"></span>
            <span class="text-[11px] text-gray-500">دردشة آمنة</span>
          </div>
        </header>

        <div id="messages" class="flex-1 overflow-y-auto scrollbar p-3 space-y-3 bg-orange-50/40 rounded-xl">
          <div class="text-center text-sm text-gray-400">اختر محادثة من القائمة أو ابدأ محادثة جديدة.</div>
        </div>

        <form id="sendForm" class="mt-3 pt-3 border-t border-gray-200 flex items-center gap-2">
          <input id="msgInput" type="text" placeholder="اكتب رسالتك..."
            class="flex-1 border border-gray-300 rounded-full px-4 py-2.5 text-sm focus:ring-orange-400 focus:border-orange-400"
            disabled>
          <button id="sendBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2.5 rounded-full text-sm font-semibold"
            disabled>إرسال</button>
        </form>
      </section>

    </div>
  </main>

  <!-- Auth Modal -->
  <div id="authModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
    <div class="bg-white w-full max-w-md rounded-xl shadow-lg p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 id="authTitle" class="text-lg font-bold">تسجيل الدخول</h3>
        <button id="closeAuth" class="text-gray-500 hover:text-gray-700"><i data-feather="x"></i></button>
      </div>

      <div id="authForms" class="space-y-4">
        <form id="loginForm" class="space-y-3">
          <div><label class="block text-sm text-gray-600">البريد الإلكتروني</label><input type="email" id="loginEmail" required class="w-full border rounded-lg px-3 py-2"></div>
          <div><label class="block text-sm text-gray-600">كلمة المرور</label><input type="password" id="loginPass" required class="w-full border rounded-lg px-3 py-2"></div>
          <div class="flex gap-2">
            <button type="submit" class="flex-1 bg-orange-500 text-white py-2 rounded-lg">دخول</button>
            <button type="button" id="showRegister" class="flex-1 border rounded-lg py-2">إنشاء حساب</button>
          </div>
        </form>

        <form id="registerForm" class="space-y-3 hidden">
          <div><label class="block text-sm text-gray-600">الاسم الكامل</label><input type="text" id="regName" required class="w-full border rounded-lg px-3 py-2"></div>
          <div><label class="block text-sm text-gray-600">البريد الإلكتروني</label><input type="email" id="regEmail" required class="w-full border rounded-lg px-3 py-2"></div>
          <div><label class="block text-sm text-gray-600">كلمة المرور</label><input type="password" id="regPass" required class="w-full border rounded-lg px-3 py-2"></div>
          <div class="flex gap-2">
            <button type="submit" class="flex-1 bg-orange-500 text-white py-2 rounded-lg">إنشاء حساب</button>
            <button type="button" id="showLogin" class="flex-1 border rounded-lg py-2">لدي حساب</button>
          </div>
        </form>
      </div>
    </div>
  </div>

<script>
  feather.replace();

<!-- ======= وضع هذا الكود داخل ملف messages.html (استبدال سكربت القديم) ======= -->
<script src="/firebase/firebase-app-compat.js"></script>
<script src="/firebase/firebase-auth-compat.js"></script>
<script src="/firebase/firebase-firestore-compat.js"></script>

<script>
/* --- ضع نفس firebaseConfig الموجود في login.html هنا --- */
const firebaseConfig = {
  apiKey: "AIzaSyBvnFMuXY_d5PKrKV-4Vp_fYyKD2c428Yw",
  authDomain: "sudegy-4c4e5.firebaseapp.com",
  projectId: "sudegy-4c4e5",
  storageBucket: "sudegy-4c4e5.appspot.com",
  messagingSenderId: "865758231874",
  appId: "1:865758231874:web:d1959356198ca1f809dcdb"
};

if (!window.firebase || !firebase.initializeApp) {
  console.error("Firebase SDK غير محمّل أو غير صحيح. تأكد من ملفات /firebase/*.js");
} else if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}

const auth = firebase.auth();
const db = firebase.firestore();

console.log("Firebase initialized for messages ✔");

/* عناصر DOM */
const chatListEl = document.getElementById('chatList');
const messagesEl = document.getElementById('messages');
const chatNameEl = document.getElementById('chatName');
const chatStatusEl = document.getElementById('chatStatus');
const statusDot = document.getElementById('statusDot');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');

let currentUser = null;
let convsUnsub = null;
let msgsUnsub = null;
let currentConversationId = null;

/* Helpers */
function escapeHtml(text = '') {
  return String(text).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[m]; });
}

/* Render conversations list */
function renderConversations(items = []) {
  if (!chatListEl) return;
  chatListEl.innerHTML = '';
  if (!items.length) {
    chatListEl.innerHTML = '<div class="p-4 text-center text-sm text-gray-500">لا توجد محادثات حتى الآن</div>';
    return;
  }
  items.forEach(c => {
    const el = document.createElement('div');
    el.className = 'flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 cursor-pointer';
    el.dataset.id = c.id;
    el.innerHTML = `
      <img src="${c.partner?.avatar || 'images/user-placeholder.jpg'}" class="w-10 h-10 rounded-full object-cover">
      <div class="flex-1">
        <p class="font-semibold text-sm">${escapeHtml(c.partner?.name || 'مستخدم')}</p>
        <p class="text-xs text-gray-500 truncate">${escapeHtml(c.lastMessage || '')}</p>
      </div>
      <span class="text-[10px] text-gray-400">${c.lastAt ? new Date(c.lastAt.seconds ? c.lastAt.seconds*1000 : c.lastAt).toLocaleString() : ''}</span>
    `;
    el.addEventListener('click', () => openConversation(c.id));
    chatListEl.appendChild(el);
  });
}

/* Load conversations realtime */
async function loadConversations() {
  if (!currentUser) return;
  if (convsUnsub) convsUnsub();

  convsUnsub = db.collection('conversations')
    .where('participants', 'array-contains', currentUser.id)
    .orderBy('lastAt', 'desc')
    .onSnapshot(async snap => {
      const items = [];
      snap.forEach(doc => {
        const d = doc.data();
        const partnerId = Array.isArray(d.participants) ? d.participants.find(p => p !== currentUser.id) : null;
        items.push({ id: doc.id, partnerId, lastMessage: d.lastMessage || '', lastAt: d.lastAt || null });
      });

      // build unique partnerIds array
      const partnerIds = Array.from(new Set(items.map(i => i.partnerId).filter(Boolean)));
      if (partnerIds.length === 0) return renderConversations(items);

      // fetch partner profiles in batch (Firestore 'in' supports up to 10 ids)
      try {
        const usersSnap = await db.collection('users').where(firebase.firestore.FieldPath.documentId(), 'in', partnerIds).get();
        const usersMap = {};
        usersSnap.forEach(u => usersMap[u.id] = u.data());
        const enriched = items.map(it => ({ ...it, partner: usersMap[it.partnerId] || { name: 'مستخدم' } }));
        renderConversations(enriched);
      } catch (err) {
        console.error('Error fetching partner profiles', err);
        renderConversations(items); // fallback
      }
    }, err => {
      console.error('conversations onSnapshot error', err);
    });
}

/* Render messages */
function renderMessages(items = []) {
  if (!messagesEl) return;
  messagesEl.innerHTML = '';
  if (!items.length) {
    messagesEl.innerHTML = '<div class="text-center text-sm text-gray-400">لا توجد رسائل بعد.</div>';
    return;
  }
  items.forEach(m => {
    const wrapper = document.createElement('div');
    wrapper.className = (m.from === currentUser.id) ? 'self-end max-w-[75%]' : 'self-start max-w-[75%]';
    wrapper.innerHTML = `
      <div class="${m.from === currentUser.id ? 'bg-orange-500 text-white' : 'bg-white'} rounded-2xl px-4 py-2 shadow-sm text-[13px] ${m.from === currentUser.id ? 'rounded-br-sm' : 'rounded-bl-sm'}">
        ${escapeHtml(m.text)}
      </div>
      <div class="text-[10px] text-gray-400 mt-1 ${m.from === currentUser.id ? 'text-left' : ''}">${m.createdAt && m.createdAt.toDate ? m.createdAt.toDate().toLocaleString() : (m.createdAt ? new Date(m.createdAt).toLocaleString() : '')}</div>
    `;
    messagesEl.appendChild(wrapper);
  });
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* Open conversation and listen realtime */
async function openConversation(convId) {
  currentConversationId = convId;
  if (msgsUnsub) msgsUnsub();

  try {
    const convDoc = await db.collection('conversations').doc(convId).get();
    if (!convDoc.exists) {
      messagesEl.innerHTML = '<div class="p-4 text-center text-sm text-red-500">محادثة غير موجودة</div>';
      return;
    }
    const conv = convDoc.data();
    const partnerId = Array.isArray(conv.participants) ? conv.participants.find(p => p !== currentUser.id) : null;
    if (partnerId) {
      const partnerDoc = await db.collection('users').doc(partnerId).get();
      chatNameEl.innerText = partnerDoc.exists ? (partnerDoc.data().name || partnerDoc.data().email) : 'مستخدم';
    } else chatNameEl.innerText = 'محادثة';

    msgsUnsub = db.collection('conversations').doc(convId).collection('messages')
      .orderBy('createdAt')
      .onSnapshot(snap => {
        const msgs = [];
        snap.forEach(d => msgs.push({ id: d.id, ...d.data() }));
        renderMessages(msgs);
      }, err => console.error('messages onSnapshot error', err));
  } catch (err) {
    console.error('openConversation error', err);
    alert('خطأ عند فتح المحادثة: ' + (err.message || err));
  }
}

/* Send message */
document.getElementById('sendForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!currentConversationId) return alert('اختر محادثة أولاً');
  const text = msgInput.value.trim();
  if (!text) return;
  try {
    const messagesRef = db.collection('conversations').doc(currentConversationId).collection('messages');
    await messagesRef.add({
      from: currentUser.id,
      text,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      read: false
    });
    await db.collection('conversations').doc(currentConversationId).update({
      lastMessage: text,
      lastAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    msgInput.value = '';
  } catch (err) {
    console.error('sendMessage error', err);
    alert('فشل إرسال الرسالة: ' + (err.message || err));
  }
});

/* Utility: deterministic conversation id */
async function getOrCreateConversationWith(targetUid) {
  if (!currentUser) throw new Error('Not authenticated');
  const pair = [currentUser.id, targetUid].sort();
  const convId = pair.join('_');
  const convRef = db.collection('conversations').doc(convId);
  const convSnap = await convRef.get();
  if (!convSnap.exists) {
    await convRef.set({
      participants: pair,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      lastMessage: '',
      lastAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }
  return convId;
}

/* Read convId from URL */
function getQueryParam(name) {
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}

/* Auth state handling */
auth.onAuthStateChanged(async (user) => {
  if (user) {
    currentUser = { id: user.uid, name: user.displayName || user.email, email: user.email };
    // UI updates
    document.getElementById('openLoginBtn')?.classList.add('hidden');
    document.getElementById('logoutBtn')?.classList.remove('hidden');
    document.getElementById('logoutBtn') && (document.getElementById('logoutBtn').innerText = 'خروج — ' + (currentUser.name || currentUser.email));
    msgInput.disabled = false; sendBtn.disabled = false;
    await loadConversations();
    const urlConv = getQueryParam('convId');
    if (urlConv) openConversation(urlConv);
  } else {
    currentUser = null;
    document.getElementById('openLoginBtn')?.classList.remove('hidden');
    document.getElementById('logoutBtn')?.classList.add('hidden');
    document.getElementById('chatList') && (document.getElementById('chatList').innerHTML = '<div class="p-4 text-center text-sm text-gray-500">سجل الدخول لعرض محادثاتك.</div>');
    document.getElementById('messages') && (document.getElementById('messages').innerHTML = '<div class="text-center text-sm text-gray-400">سجّل الدخول لعرض وبدء المحادثات.</div>');
    msgInput.disabled = true; sendBtn.disabled = true;
    if (convsUnsub) convsUnsub(); if (msgsUnsub) msgsUnsub();
  }
});
</script>
<!-- ======= نهاية السكربت المنقح ======= -->

  /********* Conversations loading (realtime) *********/
  const chatListEl = document.getElementById('chatList');
  function renderConversations(items=[]) {
    chatListEl.innerHTML = '';
    if (!items.length) {
      chatListEl.innerHTML = '<div class="p-4 text-center text-sm text-gray-500">لا توجد محادثات حتى الآن</div>';
      return;
    }
    items.forEach(c => {
      const el = document.createElement('div');
      el.className = 'chat-item p-3 flex items-center gap-3 cursor-pointer hover:bg-orange-50 rounded-xl transition';
      el.dataset.id = c.id;
      el.innerHTML = `
        <img src="${c.partner?.avatar || 'images/user-placeholder.jpg'}" class="w-10 h-10 rounded-full object-cover">
        <div class="flex-1">
          <p class="font-semibold text-sm">${escapeHtml(c.partner?.name || 'مستخدم')}</p>
          <p class="text-xs text-gray-500 truncate">${escapeHtml(c.lastMessage || '')}</p>
        </div>
        <span class="text-[10px] text-gray-400">${c.lastAt ? new Date(c.lastAt.seconds ? c.lastAt.seconds*1000 : c.lastAt).toLocaleString() : ''}</span>
      `;
      el.addEventListener('click', () => openConversation(c.id));
      chatListEl.appendChild(el);
    });
  }

  async function loadConversations() {
    if (!currentUser) return;
    if (convsUnsub) convsUnsub();
    convsUnsub = db.collection('conversations')
      .where('participants', 'array-contains', currentUser.id)
      .orderBy('lastAt', 'desc')
      .onSnapshot(async snap => {
        const items = [];
        snap.forEach(doc => {
          const d = doc.data();
          const partnerId = Array.isArray(d.participants) ? d.participants.find(p => p !== currentUser.id) : null;
          items.push({ id: doc.id, partnerId, lastMessage: d.lastMessage || '', lastAt: d.lastAt || null });
        });
        // fetch partner profiles (small batch)
        const partnerIds = [...new Set(items.map(i => i.partnerId).filter(Boolean))];
        if (partnerIds.length === 0) return renderConversations(items);
        // Firestore 'in' supports up to 10 ids; for >10 you can batch
        const usersSnap = await db.collection('users').where(firebase.firestore.FieldPath.documentId(), 'in', partnerIds).get();
        const usersMap = {};
        usersSnap.forEach(u => usersMap[u.id] = u.data());
        const enriched = items.map(it => ({ ...it, partner: usersMap[it.partnerId] || { name: 'مستخدم' } }));
        renderConversations(enriched);
      }, err => {
        console.error('conversations onSnapshot error', err);
      });
  }

  /********* Open conversation & listen messages realtime *********/
  const messagesEl = document.getElementById('messages');
  const chatNameEl = document.getElementById('chatName');
  const chatStatusEl = document.getElementById('chatStatus');
  const statusDot = document.getElementById('statusDot');

  function renderMessages(items=[]) {
    messagesEl.innerHTML = '';
    if (!items.length) {
      messagesEl.innerHTML = '<div class="text-center text-sm text-gray-400">لا توجد رسائل بعد.</div>';
      return;
    }
    items.forEach(m => {
      const wrapper = document.createElement('div');
      wrapper.className = (m.from === currentUser.id) ? 'self-end max-w-[75%]' : 'self-start max-w-[75%]';
      wrapper.innerHTML = `
        <div class="${m.from === currentUser.id ? 'bg-orange-500 text-white' : 'bg-white'} rounded-2xl px-4 py-2 shadow-sm text-[13px] ${m.from === currentUser.id ? 'rounded-br-sm' : 'rounded-bl-sm'}">
          ${escapeHtml(m.text)}
        </div>
        <div class="text-[10px] text-gray-400 mt-1 ${m.from === currentUser.id ? 'text-left' : ''}">${m.createdAt && m.createdAt.toDate ? m.createdAt.toDate().toLocaleString() : (m.createdAt ? new Date(m.createdAt).toLocaleString() : '')}</div>
      `;
      messagesEl.appendChild(wrapper);
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  async function openConversation(convId) {
    currentConversationId = convId;
    // unsubscribe previous
    if (msgsUnsub) msgsUnsub();
    // get partner name
    const convDoc = await db.collection('conversations').doc(convId).get();
    if (!convDoc.exists) {
      messagesEl.innerHTML = '<div class="p-4 text-center text-sm text-red-500">محادثة غير موجودة</div>';
      return;
    }
    const conv = convDoc.data();
    const partnerId = Array.isArray(conv.participants) ? conv.participants.find(p => p !== currentUser.id) : null;
    if (partnerId) {
      const partnerDoc = await db.collection('users').doc(partnerId).get();
      chatNameEl.innerText = partnerDoc.exists ? (partnerDoc.data().name || partnerDoc.data().email) : 'مستخدم';
    } else chatNameEl.innerText = 'محادثة';

    // listen to messages subcollection
    msgsUnsub = db.collection('conversations').doc(convId).collection('messages')
      .orderBy('createdAt')
      .onSnapshot(snap => {
        const msgs = [];
        snap.forEach(d => msgs.push({ id: d.id, ...d.data() }));
        renderMessages(msgs);
      }, err => console.error('messages onSnapshot error', err));
  }

  /********* Send message *********/
  document.getElementById('sendForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentConversationId) return alert('اختر محادثة أولاً');
    const text = msgInput.value.trim();
    if (!text) return;
    try {
      const messagesRef = db.collection('conversations').doc(currentConversationId).collection('messages');
      await messagesRef.add({
        from: currentUser.id,
        text,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        read: false
      });
      // update conversation summary
      await db.collection('conversations').doc(currentConversationId).update({
        lastMessage: text,
        lastAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      msgInput.value = '';
    } catch (err) {
      console.error('sendMessage error', err);
      alert('فشل إرسال الرسالة: ' + err.message);
    }
  });

  /********* Utility: create or get conversation between two users (deterministic id) *********/
  // استخدام هذا من صفحة المنتج: getOrCreateConversationWith(sellerUid) ثم إعادة توجيه إلى messages.html?convId=...
  async function getOrCreateConversationWith(targetUid) {
    if (!currentUser) throw new Error('Not authenticated');
    const pair = [currentUser.id, targetUid].sort();
    const convId = pair.join('_'); // deterministic conv id
    const convRef = db.collection('conversations').doc(convId);
    const convSnap = await convRef.get();
    if (!convSnap.exists) {
      await convRef.set({
        participants: pair,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        lastMessage: '',
        lastAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    return convId;
  }

  /********* Helper: read convId from URL *********/
  function getQueryParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }

  /********* Small helpers *********/
  function escapeHtml(text = '') {
    return String(text).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[m]; });
  }

  // Expose getOrCreateConversationWith to global so user-profile can call it if loaded on same domain
  window.getOrCreateConversationWith = getOrCreateConversationWith;

</script>
// هل firebase موجود؟
console.log("firebase:", typeof firebase !== 'undefined');

// هل auth جاهز وهل في user؟
console.log("auth ready?:", firebase && firebase.auth ? true : false);
if (firebase && firebase.auth) {
  console.log("current user:", firebase.auth().currentUser);
}

// جرّب قراءة وثيقة اختبارية من messages (تغيير الاسم حسب مشروعك)
firebase.firestore().collection('messages').limit(1).get()
  .then(snap => console.log("messages doc count:", snap.size, snap.docs.map(d=>d.id)))
  .catch(err => console.error("firestore read error:", err));

</body>
</html>




