<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SudEgy — الرسائل</title>

  <!-- Tailwind CDN (سريع للتطوير). في الإنتاج يُفضّل بناء Tailwind محلياً -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* لمسات صغيرة متوافقة مع الهوية */
    :root{
      --brand-orange: #ff7a28;
      --brand-navy: #0b2a56;
      --panel:#0f2748;
      --muted:#f6efe9;
    }
    body{font-family: Inter, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      backdrop-filter: blur(6px);
    }
    /* scrollbar small */
    ::-webkit-scrollbar{height:10px;width:8px}
    ::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.12);border-radius:8px}
  </style>
</head>
<body class="bg-gradient-to-b from-[#0b2a56] to-[#0a203f] min-h-screen text-gray-800">

  <header class="max-w-6xl mx-auto p-6 flex items-center justify-between text-white">
    <div class="flex items-center gap-4">
      <div class="bg-white/10 p-3 rounded-lg shadow">
        <img src="/images/logo.png" alt="SudEgy" class="h-8" onerror="this.style.display='none'"/>
      </div>
      <div>
        <h1 class="text-2xl font-semibold">SudEgy</h1>
        <p class="text-sm text-gray-200/80">منصة ربط الأعمال بين مصر والسودان</p>
      </div>
    </div>

    <div class="flex items-center gap-4">
      <button id="loginBtn" class="bg-white/10 text-white px-4 py-2 rounded-lg hover:bg-white/20">تسجيل / دخول</button>
      <div id="userBadge" class="hidden bg-white/10 text-white px-4 py-2 rounded-lg flex items-center gap-2">
        <img id="userAvatarSmall" src="/images/user-placeholder.png" class="w-8 h-8 rounded-full object-cover" />
        <span id="userEmail" class="text-sm"></span>
        <button id="logoutBtn" class="ml-2 text-xs underline">خروج</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto grid grid-cols-12 gap-6 p-6">
    <!-- Sidebar: المحادثات -->
    <aside class="col-span-4">
      <div class="glass rounded-2xl p-4 shadow-lg border border-white/5">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-semibold text-lg text-white">المحادثات</h2>
          <span id="conversationsCount" class="text-sm text-gray-200/70">--</span>
        </div>

        <div class="mb-3">
          <input id="searchConvos" placeholder="ابحث في المحادثات..." class="w-full rounded-full px-3 py-2 bg-white/5 text-white placeholder:text-white/60 focus:outline-none"/>
        </div>

        <div id="conversationsList" class="space-y-3 max-h-[60vh] overflow-auto pr-2">
          <!-- عناصر المحادثات تُضاف هنا -->
          <div class="text-center text-white/50 py-12">جارٍ التحميل...</div>
        </div>
      </div>
    </aside>

    <!-- Main: نافذة الدردشة -->
    <section class="col-span-8">
      <div class="glass rounded-2xl p-6 shadow-lg border border-white/5 min-h-[60vh] flex flex-col">
        <div id="chatHeader" class="flex items-center justify-between mb-4">
          <div>
            <h3 id="chatTitle" class="text-xl text-white font-semibold">اختر محادثة لبدء الدردشة</h3>
            <p id="chatSubtitle" class="text-sm text-white/60">يمكنك التواصل فقط مع مستخدمين مُسجلين</p>
          </div>
          <div id="chatStatus" class="text-sm text-white/60">غير متصل</div>
        </div>

        <div id="messagesContainer" class="flex-1 overflow-auto p-2 space-y-4 bg-white/5 rounded-lg">
          <!-- رسائل المحادثة -->
          <div class="text-center text-white/50 mt-20">لا توجد محادثات حتى الآن.</div>
        </div>

        <form id="sendForm" class="mt-4 flex gap-3 items-center" onsubmit="return false;">
          <input id="messageInput" placeholder="اكتب رسالتك..." class="flex-1 rounded-full px-4 py-3 bg-white/10 placeholder:text-white/60 text-white focus:outline-none" />
          <button id="sendBtn" class="bg-gradient-to-r from-[#ff8a4d] to-[#ff5b8a] text-white px-5 py-3 rounded-full shadow hover:opacity-95">إرسال</button>
        </form>
      </div>
    </section>
  </main>

  <!-- تسجيل الدخول مودال (مبسط) -->
  <div id="loginModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-[420px]">
      <h3 class="text-lg font-semibold mb-2">تسجيل الدخول</h3>
      <p class="text-sm text-gray-500 mb-4">سجّل دخولك للتواصل مع المسجلين</p>
      <input id="emailField" placeholder="البريد الإلكتروني" class="w-full rounded-md p-3 mb-3 border" />
      <input id="passField" placeholder="كلمة المرور" type="password" class="w-full rounded-md p-3 mb-4 border" />
      <div class="flex gap-3">
        <button id="modalLoginBtn" class="bg-[#ff7a28] text-white px-4 py-2 rounded-md">تسجيل دخول</button>
        <button id="modalCloseBtn" class="bg-gray-100 px-4 py-2 rounded-md">إغلاق</button>
      </div>
      <p id="loginError" class="text-sm text-red-500 mt-3 hidden"></p>
    </div>
  </div>

  <!-- Firebase SDKs (compat) - ملفات محلية كما في repo -->
  <script src="/firebase/firebase-app-compat.js"></script>
  <script src="/firebase/firebase-auth-compat.js"></script>
  <script src="/firebase/firebase-firestore-compat.js"></script>

  <!-- التطبيق / منطق الرسائل -->
  <script>
  /* ======= إعداد Firebase آمن (لا تهيئ أكثر من مرة) ======= */
  const firebaseConfig = {
    apiKey: "AIzaSyBvnFMuXY_d5PKrKV-4Vp_fYyKD2c428Yw",
    authDomain: "sudegy-4c4e5.firebaseapp.com",
    projectId: "sudegy-4c4e5",
    storageBucket: "sudegy-4c4e5.appspot.com",
    messagingSenderId: "865758231874",
    appId: "1:865758231874:web:d1959356198ca1f809dcdb"
  };

  if (typeof firebase !== 'undefined') {
    if (!firebase.apps || firebase.apps.length === 0) {
      firebase.initializeApp(firebaseConfig);
      console.log('Firebase initialized (fresh).');
    } else {
      console.log('Firebase already initialized (reused).');
    }
  } else {
    console.error('Firebase SDK not loaded!');
  }

  const auth = (typeof firebase !== 'undefined' && firebase.auth) ? firebase.auth() : null;
  const db = (typeof firebase !== 'undefined' && firebase.firestore) ? firebase.firestore() : null;

  /* ======= UI handles ======= */
  const loginBtn = document.getElementById('loginBtn');
  const loginModal = document.getElementById('loginModal');
  const modalCloseBtn = document.getElementById('modalCloseBtn');
  const modalLoginBtn = document.getElementById('modalLoginBtn');
  const emailField = document.getElementById('emailField');
  const passField = document.getElementById('passField');
  const loginError = document.getElementById('loginError');

  const userBadge = document.getElementById('userBadge');
  const userEmailEl = document.getElementById('userEmail');
  const userAvatarSmall = document.getElementById('userAvatarSmall');
  const logoutBtn = document.getElementById('logoutBtn');

  const convosListEl = document.getElementById('conversationsList');
  const conversationsCount = document.getElementById('conversationsCount');
  const searchConvos = document.getElementById('searchConvos');

  const chatTitle = document.getElementById('chatTitle');
  const chatSubtitle = document.getElementById('chatSubtitle');
  const chatStatus = document.getElementById('chatStatus');

  const messagesContainer = document.getElementById('messagesContainer');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');

  let currentUser = null;
  let currentConversationId = null;
  let convsUnsub = null;
  let msgsUnsub = null;

  /* helper: safe avatar url */
  function avatarUrlFor(partner){
    if(!partner) return '/images/user-placeholder.png';
    if(partner.avatar && partner.avatar.length) return partner.avatar;
    return '/images/user-placeholder.png';
  }

  /* ======= Authentication ======= */
  loginBtn.addEventListener('click', ()=> loginModal.classList.remove('hidden'));
  modalCloseBtn.addEventListener('click', ()=> loginModal.classList.add('hidden'));

  modalLoginBtn.addEventListener('click', async () => {
    loginError.classList.add('hidden');
    const email = emailField.value.trim();
    const pass = passField.value;
    if(!email || !pass){ loginError.textContent = 'أدخل البريد وكلمة المرور.'; loginError.classList.remove('hidden'); return; }
    try{
      await auth.signInWithEmailAndPassword(email, pass);
      loginModal.classList.add('hidden');
      emailField.value=''; passField.value='';
    }catch(e){
      loginError.textContent = e.message || 'خطأ في تسجيل الدخول';
      loginError.classList.remove('hidden');
    }
  });

  logoutBtn?.addEventListener('click', async ()=> {
    await auth.signOut();
  });

  /* ======= Auth state ======= */
  auth.onAuthStateChanged(async user => {
    currentUser = user;
    if(user){
      userBadge.classList.remove('hidden');
      loginBtn.classList.add('hidden');
      userEmailEl.textContent = user.email || 'مستخدم';
      userAvatarSmall.src = '/images/user-placeholder.png';
      // لو ترغب في جلب بروفايل مستخدم من users collection ضع هنا
      // load conversations
      startConversationsRealtime();
    } else {
      userBadge.classList.add('hidden');
      loginBtn.classList.remove('hidden');
      conversationsCount.textContent = '--';
      convosListEl.innerHTML = '<div class="text-center text-white/50 py-12">سجل دخول لعرض المحادثات</div>';
      // unsubs
      if(convsUnsub){ convsUnsub(); convsUnsub = null; }
      if(msgsUnsub){ msgsUnsub(); msgsUnsub = null; }
      chatTitle.textContent = 'اختر محادثة لبدء الدردشة';
      messagesContainer.innerHTML = '<div class="text-center text-white/50 mt-20">لا توجد محادثات حتى الآن.</div>';
    }
  });

  /* ======= Conversations realtime ======= */
  function startConversationsRealtime(){
    if(!currentUser) return;
    // Unsubscribe old
    if(convsUnsub) convsUnsub();

    const q = db.collection('conversations')
                .where('participants', 'array-contains', currentUser.uid)
                .orderBy('lastAt', 'desc');

    convsUnsub = q.onSnapshot(snapshot => {
      const items = [];
      snapshot.forEach(d => {
        items.push({ id: d.id, ...d.data() });
      });
      renderConversations(items);
    }, err => {
      console.error('conversations onSnapshot error', err);
      convosListEl.innerHTML = '<div class="text-red-400 p-3">خطأ في تحميل المحادثات.</div>';
    });
  }

  function renderConversations(items = []){
    convosListEl.innerHTML = '';
    conversationsCount.textContent = items.length + ' ';
    if(!items.length){
      convosListEl.innerHTML = '<div class="text-center text-white/50 py-12">لا توجد محادثات حتى الآن.</div>';
      return;
    }
    items.forEach(c => {
      const el = document.createElement('div');
      el.className = 'flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 cursor-pointer';
      el.dataset.id = c.id;

      // partner is the other user info {name, avatar}
      // determine partner object (assumes conversation doc has partner data or participants info)
      const partner = c.partner || {};
      const avatar = avatarUrlFor(partner);

      // build inner
      el.innerHTML = `
        <img src="${avatar}" onerror="this.onerror=null;this.src='/images/user-placeholder.png'" class="w-12 h-12 rounded-full object-cover" />
        <div class="flex-1">
          <div class="flex items-center justify-between">
            <div class="text-white font-medium">${escapeHtml(partner.name || 'مستخدم')}</div>
            <div class="text-xs text-white/60">${formatTime(c.lastAt)}</div>
          </div>
          <div class="text-sm text-white/60 mt-1">${escapeHtml(c.lastMessage || 'بدء محادثة')}</div>
        </div>
      `;

      el.addEventListener('click', ()=> openConversation(c.id, c));
      convosListEl.appendChild(el);
    });
  }

  /* ======= Open conversation, load messages realtime ======= */
  function openConversation(convId, convData){
    // unsubscribe previous messages
    if(msgsUnsub) msgsUnsub();

    currentConversationId = convId;
    chatTitle.textContent = convData.partner?.name || 'محادثة';
    chatSubtitle.textContent = 'تواصل مباشر';

    // mark unread? (اختياري)
    chatStatus.textContent = 'متصل';
    messagesContainer.innerHTML = '<div class="text-center text-white/50 py-8">جارٍ تحميل المحادثة...</div>';

    const msgsRef = db.collection('messages')
                      .where('conversationId','==',convId)
                      .orderBy('createdAt','asc');

    msgsUnsub = msgsRef.onSnapshot(snapshot => {
      const msgs = [];
      snapshot.forEach(d => msgs.push({ id: d.id, ...d.data() }));
      renderMessages(msgs);
    }, err => {
      console.error('messages onSnapshot error', err);
      messagesContainer.innerHTML = '<div class="text-red-400 p-3">خطأ في تحميل الرسائل.</div>';
    });
  }

  function renderMessages(msgs = []){
    messagesContainer.innerHTML = '';
    if(!msgs.length){
      messagesContainer.innerHTML = '<div class="text-center text-white/50 py-12">لا توجد رسائل حتى الآن. ابدأ المحادثة بقول مرحباً.</div>';
      return;
    }
    msgs.forEach(m => {
      const me = (m.from === currentUser.uid);
      const wrapper = document.createElement('div');
      wrapper.className = me ? 'flex justify-end' : 'flex justify-start';
      const bubble = document.createElement('div');
      bubble.className = (me ? 'bg-[#ff8a4d] text-white' : 'bg-white/10 text-white') + ' p-3 rounded-lg max-w-[70%]';
      bubble.innerHTML = `<div class="text-sm">${escapeHtml(m.text || '')}</div>
                          <div class="text-xs text-white/60 mt-2 text-left">${formatTime(m.createdAt)}</div>`;
      wrapper.appendChild(bubble);
      messagesContainer.appendChild(wrapper);
    });
    // scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  /* ======= Send message ======= */
  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keydown', e => { if(e.key === 'Enter') sendMessage(); });

  async function sendMessage(){
    const txt = messageInput.value.trim();
    if(!txt || !currentUser || !currentConversationId) return;
    const payload = {
      conversationId: currentConversationId,
      from: currentUser.uid,
      text: txt,
      createdAt: new Date()
    };
    try{
      await db.collection('messages').add(payload);
      // update last message and lastAt in conversation doc
      await db.collection('conversations').doc(currentConversationId).update({
        lastMessage: txt,
        lastAt: new Date()
      });
      messageInput.value = '';
    }catch(e){
      console.error('send failed', e);
    }
  }

  /* ======= small utilities ======= */
  function escapeHtml(str){
    if(!str) return '';
    return String(str).replace(/[&<>"'`]/g, function(s){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;', '`':'&#96;'}[s]; });
  }
  function formatTime(value){
    try{
      if(!value) return '';
      // value might be Firestore Timestamp or Date
      let d = value.toDate ? value.toDate() : (value instanceof Date ? value : new Date(value));
      return d.toLocaleString('ar-EG', {hour: '2-digit', minute:'2-digit'});
    }catch(e){ return ''; }
  }

  /* ======= helper: safe start ======= */
  // small safeguard: if page loads and user already authed, start conversations
  // auth.onAuthStateChanged above already calls startConversationsRealtime when user exists

  /* ======= search filter (local) ======= */
  searchConvos.addEventListener('input', e => {
    const q = e.target.value.trim().toLowerCase();
    const nodes = convosListEl.querySelectorAll('[data-id]');
    nodes.forEach(n => {
      const txt = n.textContent.toLowerCase();
      n.style.display = txt.includes(q) ? '' : 'none';
    });
  });

  // Optional: quick init display when SDK not ready
  console.log('Messages UI ready.');
  </script>
<script>
gtag('event', 'open_messages', {
  event_category: 'Engagement',
  event_label: 'Messages Page'
});
</script>

</body>
</html>

